<!DOCTYPE html>
<!--suppress ALL -->
<html lang=pt>
<head>
    <title>Hello Firebase Login</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="node_modules/sweetalert/dist/sweetalert.css">
    <script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://use.fontawesome.com/9459e1215b.js"></script>
    <script src="node_modules/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>
<div id="login" class="cartao hide">
    <div class="login cartao">
        <img src="google_firebase-2-128.png">
        <h1>Bem vindo ao Firebase Login</h1>
        <button onclick="facebookLogin()" class="face"><i class="fa fa-facebook-square" aria-hidden="true"></i>Entrar
            com <b>Facebook</b></button>
        <button onclick="googleLogin()" class="google"><i class="fa fa-google" aria-hidden="true"></i>Entrar com Google
        </button>
        <button onclick="anonimoLogin()" class="anonimo"><i class="fa fa-user" aria-hidden="true"></i>Entrar como
            Anônimo
        </button>

    </div>
    <span class="overlay"></span>
</div>

<div class="firelogin hide cartao">
    <div>
        <img class="avatar" id="foto">
        <h1 id="username"></h1>
        <h3 id="email"></h3>
    </div>
    <div style="margin-top: 50px">
        <img src="google_firebase-2-128.png">
        <h4>Seja bem vindo ao</h4>
        <p>Firebase Login <i id="iconLogado" class="fa" aria-hidden="true"></i></p>
        <button class="logout" onclick="logout()"><i class="fa fa-sign-out" aria-hidden="true"></i> Sair</button>
    </div>

</div>
<script>
    var config = {
        apiKey: "AIzaSyAOlL5BIsqbuCT1C3KnJQUY14J1UcUmbgg",
        authDomain: "hello-fb-login.firebaseapp.com",
        databaseURL: "https://hello-fb-login.firebaseio.com",
        storageBucket: "hello-fb-login.appspot.com"
    };

    function logout() {
        firebase.auth().signOut();
        $(".firelogin").addClass("hide");
        $("#login").removeClass("hide");
        limparSessao();
    }

    function salveUserNaSessao(user) {
        sessionStorage.nome = user.displayName;
        sessionStorage.email = user.email;
        sessionStorage.foto = user.photoURL;
    }

    function limparSessao() {
        sessionStorage.clear();
    }

    function preenchaUsuario() {
        $("#username").text(sessionStorage.nome);
        $("#email").text(sessionStorage.email);
        $("#foto").attr("src", sessionStorage.foto);
        $(".firelogin").removeClass("hide");
        $("#login").addClass("hide");
    }

    function facebookLogin() {
        console.debug("Entrando com Facebook...");
        var provider = new firebase.auth.FacebookAuthProvider();
        var me = this;

        firebase.auth().signInWithPopup(provider).then(function (result) {
            $("#iconLogado").addClass("fa-facebook-square");
            $("#iconLogado").removeClass("fa-google fa-user");
            $(".firelogin").removeClass("hide");
            $("#login").addClass("hide ativo");
            window.salveUserNaSessao(result.user)
            window.preenchaUsuario();
        }).catch(function (error) {
            if (error.code === 'auth/account-exists-with-different-credential') {
                var email = error.email;
                firebase.auth().fetchProvidersForEmail(email).then(function (providers) {
                    sweetAlert("Não deu ;(", 'Você já logou com o email ' + email + ' usando método de autenticação ' + providers, "error");
                });

            } else {
                console.error("ERRO: " + error.code);
                console.error("Falha ao logar: " + error);
            }
        });
    }

    function googleLogin() {
        console.debug("Entrando com Google...");
        var provider = new firebase.auth.GoogleAuthProvider();
        var me = this;
        firebase.auth().signInWithPopup(provider).then(function (result) {
            $("#iconLogado").addClass("fa-google");
            $("#iconLogado").removeClass("fa-facebook-square fa-user");
            window.salveUserNaSessao(result.user)
            window.preenchaUsuario();
        }).catch(function (error) {
            console.error("Falha ao logar: " + error);
        });
    }

    function anonimoLogin() {
        console.debug("Entrando Anônimamente...");
        firebase.auth().signInAnonymously().catch(function (error) {
            console.error("Falha ao logar: " + error);
        });

        firebase.auth().onAuthStateChanged(function (user) {
            if (user && user.isAnonymous) {
                $("#iconLogado").addClass("fa-user");
                $("#iconLogado").removeClass("fa-facebook-square fa-google");
                window.salveUserNaSessao({
                    displayName: 'Mistéérioo',
                    email: '@nonimo',
                    photoURL: 'https://scontent.fcpq1-1.fna.fbcdn.net/v/t1.0-1/c15.15.190.190/s160x160/482865_107766019411218_1824143669_n.jpg?oh=233c546aafa3f867c19151aebe803804&oe=582AB1AD'
                });
                window.preenchaUsuario();
            } else if (!user) {
                console.log("Deslogou");
            }
        });
    }

    function verificaUsuarioLogado() {
        if (sessionStorage.nome) {
            console.debug("preencher usuário");
            preenchaUsuario();
        } else {
            console.debug("LOGAR");
            $("#login").removeClass("hide");
        }
    }

    window.onload = function () {
        firebase.initializeApp(config);
        verificaUsuarioLogado();
    };
</script>
</body>
</html>
