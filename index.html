<!DOCTYPE html>
<!--suppress ALL -->
<html lang=pt>
<head>
    <title>Hello Firebase Login</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/3.2.0/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://use.fontawesome.com/9459e1215b.js"></script>
</head>

<body>
<div id="login" class="cartao">
    <div class="login cartao">
        <img src="google_firebase-2-128.png">
        <h1>Bem vindo ao Firebase Login</h1>
        <button onclick="facebookLogin()" class="face"><i class="fa fa-facebook-square" aria-hidden="true"></i>Entrar
            com <b>Facebook</b></button>
        <button onclick="googleLogin()" class="google"><i class="fa fa-google" aria-hidden="true"></i>Entrar com Google
        </button>
        <button onclick="anonimoLogin()" class="anonimo"><i class="fa fa-user" aria-hidden="true"></i>Entrar como
            Anônimo
        </button>

    </div>
    <span class="overlay"></span>
</div>

<div class="firelogin hide cartao">
    <div>
        <img class="avatar" id="foto">
        <h1 id="username"></h1>
        <h3 id="email"></h3>
    </div>
    <div style="margin-top: 50px">
        <img src="google_firebase-2-128.png">
        <h4>Seja bem vindo ao</h4>
        <p>Firebase Login <i id="iconLogado" aria-hidden="true"></i></p>
        <button class="logout" onclick="logout()"><i class="fa fa-sign-out" aria-hidden="true"></i> Sair</button>
    </div>

</div>
<script>
    var config = {
        apiKey: "AIzaSyAOlL5BIsqbuCT1C3KnJQUY14J1UcUmbgg",
        authDomain: "hello-fb-login.firebaseapp.com",
        databaseURL: "https://hello-fb-login.firebaseio.com",
        storageBucket: "hello-fb-login.appspot.com"
    };

    function logout() {
        firebase.auth().signOut();
        $(".firelogin").addClass("hide");
        $("#login").removeClass("hide");
    }


    function facebookLogin() {
        console.log("Entrando com Facebook...");
        var provider = new firebase.auth.FacebookAuthProvider();
        var me = this;

        firebase.auth().signInWithPopup(provider).then(function (result) {
            $("#iconLogado").addClass("fa fa-facebook-square");
            $("#username").text(result.user.displayName);
            $("#email").text(result.user.email);
            $("#foto").attr("src", result.user.photoURL);
            $(".firelogin").removeClass("hide");
            $("#login").addClass("hide");

        }).catch(function (error) {
            console.error("ERRO: " + error.code);
            console.error("Falha ao logar: " + error);

            if (error.code === 'auth/account-exists-with-different-credential') {
                // Step 2.
                // User's email already exists.
                // The pending Google credential.
                var pendingCred = error.credential;
                // The provider account's email address.
                var email = error.email;
                // Get registered providers for this email.
                auth.fetchProvidersForEmail(email).then(function(providers) {
                    // Step 3.
                    // If the user has several providers,
                    // the first provider in the list will be the "recommended" provider to use.
                    if (providers[0] === 'password') {
                        // Asks the user his password.
                        // In real scenario, you should handle this asynchronously.
                        var password = promptUserForPassword(); // TODO: implement promptUserForPassword.
                        auth.signInWithEmailAndPassword(email, password).then(function(user) {
                            // Step 4a.
                            return user.link(pendingCred);
                        }).then(function() {
                            // Google account successfully linked to the existing Firebase user.
                            goToApp();
                        });
                        return;
                    }
                    // All the other cases are external providers.
                    // Construct provider object for that provider.
                    // TODO: implement getProviderForProviderId.
                    var provider = getProviderForProviderId(providers[0]);
                    // At this point, you should let the user know that he already has an account
                    // but with a different provider, and let him validate the fact he wants to
                    // sign in with this provider.
                    // Sign in to provider. Note: browsers usually block popup triggered asynchronously,
                    // so in real scenario you should ask the user to click on a "continue" button
                    // that will trigger the signInWithPopup.
                    auth.signInWithPopup(provider).then(function(result) {
                        // Remember that the user may have signed in with an account that has a different email
                        // address than the first one. This can happen as Firebase doesn't control the provider's
                        // sign in flow and the user is free to login using whichever account he owns.
                        // Step 4b.
                        // Link to Google credential.
                        // As we have access to the pending credential, we can directly call the link method.
                        result.user.link(pendingCred).then(function() {
                            // Google account successfully linked to the existing Firebase user.
                            goToApp();
                        });
                    });
                });
            }
        });
    }

    function googleLogin() {
        console.debug("Entrando com Google...");
        var provider = new firebase.auth.GoogleAuthProvider();
        var me = this;
        firebase.auth().signInWithPopup(provider).then(function (result) {
            var credential = firebase.auth.GoogleAuthProvider.credential(result.user.getAuthResponse().id_token);

            $("#iconLogado").addClass("fa fa-gogole");
            $("#username").text(result.user.displayName);
            $("#email").text(result.user.email);
            $("#foto").attr("src", result.user.photoURL);
            $(".firelogin").removeClass("hide");
            $("#login").addClass("hide");
        }).catch(function (error) {
            console.error("Falha ao logar: " + error);
        });
    }

    function anonimoLogin() {
        console.debug("Entrando Anônimamente...");
        firebase.auth().signInAnonymously().catch(function (error) {
            console.error("Falha ao logar: " + error);
        });

        firebase.auth().onAuthStateChanged(function (user) {
            if (user && user.isAnonymous) {
                $("#iconLogado").addClass("fa fa-user");
                $("#username").text("Mistéérioo!");
                $("#email").text("@nonimo");
                $("#foto").attr("src", "https://scontent.fcpq1-1.fna.fbcdn.net/v/t1.0-1/c15.15.190.190/s160x160/482865_107766019411218_1824143669_n.jpg?oh=233c546aafa3f867c19151aebe803804&oe=582AB1AD");
                $(".firelogin").removeClass("hide");
                $("#login").addClass("hide");
            } else if (!user) {
                console.log("Deslogou");
            }
        });
    }

    window.onload = function () {
        firebase.initializeApp(config);
    };
</script>
</body>
</html>
